<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MÃ¼ÅŸteri Destek Paneli (Debug Mod)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { background-color: #f4f6f9; padding-top: 20px; font-family: 'Segoe UI', sans-serif; }
        .card { border: none; box-shadow: 0 2px 12px rgba(0,0,0,0.04); border-radius: 8px; }
        .loading-overlay { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 50; justify-content: center; align-items: center; }
        .ticket-id { font-weight: bold; color: #0d6efd; font-family: monospace; }
        .action-cell { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chart-card { height: 100%; padding: 15px; cursor: pointer; transition: transform 0.2s; }
        .chart-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .chart-container { position: relative; height: 250px; width: 100%; }
        .history-wrapper { background-color: #f8f9fa; border-radius: 8px; padding: 15px; max-height: 400px; overflow-y: auto; }
        .history-card { background: #fff; border-left: 4px solid #dee2e6; border-radius: 4px; padding: 10px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .history-card.status-closed { border-left-color: #6c757d; }
        .history-card.status-open { border-left-color: #198754; }
        .history-date { font-size: 0.75rem; color: #888; margin-bottom: 6px; display: block; }
        .history-detail-row { font-size: 0.9rem; margin-bottom: 4px; display: flex; align-items: flex-start; }
        .history-label { font-weight: 600; color: #555; width: 110px; flex-shrink: 0; }
        .history-val { color: #333; }
    </style>
</head>
<body>

<div class="container pb-5">
    <!-- HEADER -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
        <div>
            <h3 class="text-primary fw-bold mb-0"><i class="bi bi-shield-lock"></i> Destek Paneli</h3>
            <span id="envBadge" class="badge bg-secondary">YÃ¼kleniyor...</span>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#dashboardArea">
                <i class="bi bi-graph-up"></i> Dashboard
            </button>
            <div class="btn-group">
                <input type="radio" class="btn-check" name="mode" id="mTest" onchange="setMode('TEST')">
                <label class="btn btn-outline-warning" for="mTest">Test</label>
                <input type="radio" class="btn-check" name="mode" id="mLive" onchange="setMode('LIVE')" checked>
                <label class="btn btn-outline-success" for="mLive">CanlÄ±</label>
            </div>
            <button class="btn btn-light border" onclick="fetchTickets()"><i class="bi bi-arrow-clockwise"></i></button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNew">+ Yeni KayÄ±t</button>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div class="collapse show mb-4" id="dashboardArea">
        <div class="row g-3">
            <div class="col-lg-5">
                <div class="row g-3 h-100">
                    <div class="col-md-6">
                        <div class="card chart-card" title="Filtrelemek iÃ§in tÄ±kla">
                            <h6 class="text-muted text-center mb-2">Talep DurumlarÄ±</h6>
                            <div class="chart-container"><canvas id="chartStatus"></canvas></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card chart-card" title="Filtrelemek iÃ§in tÄ±kla">
                            <h6 class="text-muted text-center mb-2">Atanan KiÅŸiler</h6>
                            <div class="chart-container"><canvas id="chartAssigned"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="card chart-card" style="cursor: default;">
                    <h6 class="text-muted text-center mb-2">Zaman Ã‡izelgesi</h6>
                    <div class="chart-container"><canvas id="chartTimeline"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <!-- FÄ°LTRE UYARISI -->
    <div id="filterAlert" class="alert alert-warning d-flex justify-content-between align-items-center d-none mb-3">
        <span><i class="bi bi-funnel-fill"></i> <strong id="filterText"></strong> gÃ¶rÃ¼ntÃ¼leniyor.</span>
        <button class="btn btn-sm btn-outline-dark" onclick="clearFilter()">Filtreyi Temizle</button>
    </div>

    <!-- TABLO -->
    <div class="card position-relative">
        <div id="loader" class="loading-overlay"><div class="spinner-border text-primary"></div></div>
        <div class="card-header bg-white border-bottom-0 pt-3">
            <h5 class="card-title fw-bold text-secondary"><i class="bi bi-list-ul"></i> KayÄ±t Listesi</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-3">ID</th>
                        <th>Konu</th>
                        <th>Jira</th>
                        <th>Son Ä°ÅŸlem</th>
                        <th>Durum</th>
                        <th>KayÄ±t Tarihi</th>
                        <th>KapanÄ±ÅŸ Tarihi</th>
                        <th class="text-end pe-3">Ä°ÅŸlem</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        <div class="card-footer bg-white text-muted small text-end">
            Toplam KayÄ±t: <span id="count">0</span>
        </div>
    </div>
</div>

<!-- MODAL: YENÄ° KAYIT -->
<div class="modal fade" id="modalNew" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Yeni Talep</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNew">
                    <div class="alert alert-info py-1 small d-none" id="msgIdCalc">ID HesaplanÄ±yor...</div>
                    <div class="mb-2">
                        <label>Konu</label>
                        <input type="text" class="form-control" id="nSub" required>
                    </div>
                    <div class="mb-2">
                        <label>AÃ§Ä±klama</label>
                        <textarea class="form-control" id="nDesc" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-2">
                            <label>Atanan</label>
                            <input type="text" class="form-control" id="nAssigned">
                        </div>
                        <div class="col-6 mb-2">
                            <label>Ã–ncelik</label>
                            <select class="form-select" id="nPrio">
                                <option value="Normal">Normal</option>
                                <option value="High">YÃ¼ksek</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mt-3" id="btnNew">Kaydet</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: GÃœNCELLEME -->
<div class="modal fade" id="modalUpd" tabindex="-1">
    <div class="modal-dialog modal-xl"> 
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark d-flex justify-content-between">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> KayÄ±t DetayÄ± & GeÃ§miÅŸi</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Sol: GÃ¼ncelleme Formu -->
                    <div class="col-lg-5 border-end">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold text-secondary mb-0">GÃ¼ncelleme Ä°ÅŸlemi</h6>
                            <button class="btn btn-sm btn-outline-primary" id="btnJira" onclick="createJiraTask()">
                                <i class="bi bi-kanban"></i> Jira'ya Aktar
                            </button>
                        </div>
                        <form id="formUpd">
                            <input type="hidden" id="uId">
                            <div class="mb-2">
                                <label class="text-muted small">Konu</label>
                                <input type="text" class="form-control bg-light" id="uTitle" disabled>
                            </div>
                            <div class="row">
                                <div class="col-6 mb-2">
                                    <label>Durum</label>
                                    <select class="form-select" id="uStatus">
                                        <option value="open">AÃ§Ä±k</option>
                                        <option value="pending">Beklemede</option>
                                        <option value="closed">KapalÄ±</option>
                                    </select>
                                </div>
                                <div class="col-6 mb-2">
                                    <label>KapanÄ±ÅŸ Tarihi</label>
                                    <input type="date" class="form-control" id="uDate">
                                </div>
                            </div>
                            <div class="mb-2">
                                <label>YapÄ±lan Ä°ÅŸlem</label>
                                <textarea class="form-control" id="uAction" rows="3" placeholder="Bu gÃ¼ncellemede ne yapÄ±ldÄ±?"></textarea>
                            </div>
                            <button type="submit" class="btn btn-warning w-100 mt-3" id="btnUpd">DeÄŸiÅŸiklikleri Kaydet</button>
                        </form>
                    </div>
                    <!-- SaÄŸ: GeÃ§miÅŸ -->
                    <div class="col-lg-7">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="fw-bold text-secondary">Ä°ÅŸlem GeÃ§miÅŸi</h6>
                            <button class="btn btn-sm btn-light border" onclick="reloadHistory()"><i class="bi bi-arrow-clockwise"></i></button>
                        </div>
                        <div id="historyLoader" class="text-center text-muted py-5"><div class="spinner-border spinner-border-sm"></div> YÃ¼kleniyor...</div>
                        <div id="historyContent" class="history-wrapper d-none"></div>
                        <div id="historyError" class="text-danger small text-center d-none mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ===========================================
    // ðŸ”’ GÃœVENLÄ°K
    // ===========================================
    const AUTH = {
        USER: 'engincoban',
        PASS: 'E25422542c***' 
    };

    function getAuthHeaders() {
        const authString = btoa(`${AUTH.USER}:${AUTH.PASS}`);
        return {
            'Content-Type': 'application/json',
            'Authorization': `Basic ${authString}`
        };
    }

    const URLS = {
        TEST: {
            LIST:    'https://engincoban.app.n8n.cloud/webhook-test/972c0975-8e73-4234-9672-f28c534a3ed2',
            CREATE:  'https://engincoban.app.n8n.cloud/webhook-test/f830b35d-08ce-4257-adc2-07fc8e99a5be',
            UPDATE:  'https://engincoban.app.n8n.cloud/webhook-test/c18af707-3364-49fb-b310-67166e5baa80',
            HISTORY: 'https://engincoban.app.n8n.cloud/webhook-test/9e0f8e71-2c64-4570-a1b7-95cf042a535e',
            JIRA:    'https://engincoban.app.n8n.cloud/webhook-test/8414c77c-a575-4b1c-ba3e-630120925322'
        },
        LIVE: {
            LIST:    'https://engincoban.app.n8n.cloud/webhook/972c0975-8e73-4234-9672-f28c534a3ed2',
            CREATE:  'https://engincoban.app.n8n.cloud/webhook/f830b35d-08ce-4257-adc2-07fc8e99a5be',
            UPDATE:  'https://engincoban.app.n8n.cloud/webhook/c18af707-3364-49fb-b310-67166e5baa80',
            HISTORY: 'https://engincoban.app.n8n.cloud/webhook/9e0f8e71-2c64-4570-a1b7-95cf042a535e',
            JIRA:    'https://engincoban.app.n8n.cloud/webhook/8414c77c-a575-4b1c-ba3e-630120925322'
        }
    };

    let mode = 'LIVE';
    let allTickets = [];
    let charts = { status: null, assigned: null, timeline: null };

    function setMode(m) {
        mode = m;
        const badge = document.getElementById('envBadge');
        if(m==='TEST'){ badge.className='badge bg-warning text-dark'; badge.innerText='TEST MODU'; }
        else { badge.className='badge bg-success'; badge.innerText='CANLI ORTAM'; }
        fetchTickets();
    }

    async function getNextId() {
        try {
            const res = await fetch(URLS[mode].LIST, { method: 'GET', headers: getAuthHeaders() });
            const json = await res.json();
            let data = parseData(json);
            if(data.length === 0) return 1;
            const ids = data.map(x => parseInt(x["Ticket ID"] || x["id"] || 0));
            return Math.max(...ids) + 1;
        } catch { return Math.floor(Date.now()/1000); }
    }

    function parseData(json) {
        if(Array.isArray(json) && json[0]?.data) return json[0].data;
        if(Array.isArray(json)) return json;
        if(json.data) return json.data;
        return [];
    }

    async function fetchTickets() {
        const loader = document.getElementById('loader');
        loader.style.display = 'flex';
        clearFilter(false);
        try {
            const res = await fetch(URLS[mode].LIST, { method: 'GET', headers: getAuthHeaders() });
            if(!res.ok) throw new Error(`Hata: ${res.status}`);
            const json = await res.json();
            allTickets = parseData(json);
            allTickets.sort((a,b) => (parseInt(b["Ticket ID"])||0) - (parseInt(a["Ticket ID"])||0));
            renderDashboard(allTickets);
            renderTable(allTickets);
        } catch(e) { 
            console.error(e); 
            document.getElementById('tbody').innerHTML='<tr><td colspan="8" class="text-center text-danger">Veri alÄ±namadÄ±.</td></tr>'; 
        } finally { loader.style.display = 'none'; }
    }

    function renderTable(dataToRender) {
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';
        document.getElementById('count').innerText = dataToRender.length;
        if(!dataToRender.length) { tbody.innerHTML='<tr><td colspan="8" class="text-center p-4">KayÄ±t bulunamadÄ±.</td></tr>'; return; }
        dataToRender.forEach(t => {
            const id = t["Ticket ID"] || t["id"];
            const status = (t["Status"]||'open').toLowerCase();
            const whatAppend = t["WhatAppend"] || t["Action Taken"] || '';
            const cDate = t["Created Date"] || '';
            let closedRaw = t["Closed_Date"] || t["Completion Date"] || '';
            let closedDisplay = closedRaw;
            if(closedRaw.includes('-') && closedRaw.length===10) {
                const p = closedRaw.split('-');
                closedDisplay = `${p[2]}.${p[1]}.${p[0]}`;
            }
            const jiraKey = t["Jira_Key"] || t["jira_key"];
            const jiraUrl = t["Jira_Url"] || t["jira_url"] || '#';
            let jiraBadge = '-';
            if(jiraKey) jiraBadge = `<a href="${jiraUrl}" target="_blank" class="badge bg-primary text-decoration-none" title="Jira'da GÃ¶rÃ¼ntÃ¼le"><i class="bi bi-box-arrow-up-right"></i> ${jiraKey}</a>`;
            let badge = 'bg-secondary';
            if(status.includes('open')) badge='bg-success';
            else if(status.includes('pend')) badge='bg-warning text-dark';
            const row = `
                <tr>
                    <td class="ps-3 ticket-id">#${id}</td>
                    <td class="fw-bold">${t["Title"]||'-'}</td>
                    <td class="text-center">${jiraBadge}</td>
                    <td class="action-cell" title="${whatAppend}">${whatAppend}</td>
                    <td><span class="badge ${badge}">${status.toUpperCase()}</span></td>
                    <td class="small">${cDate}</td>
                    <td class="small">${closedDisplay}</td>
                    <td class="text-end pe-3"><button class="btn btn-sm btn-outline-dark" onclick="openUpd('${id}')"><i class="bi bi-pencil"></i></button></td>
                </tr>`;
            tbody.innerHTML += row;
        });
    }

    function renderDashboard(data) {
        if (charts.status) charts.status.destroy(); if (charts.assigned) charts.assigned.destroy(); if (charts.timeline) charts.timeline.destroy(); if (data.length === 0) return;
        const statusCounts = {}; data.forEach(item => { const s = (item["Status"] || 'Belirsiz').toLowerCase(); statusCounts[s] = (statusCounts[s] || 0) + 1; });
        const ctxStatus = document.getElementById('chartStatus').getContext('2d'); charts.status = new Chart(ctxStatus, { type: 'pie', data: { labels: Object.keys(statusCounts).map(s => s.toUpperCase()), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#198754', '#6c757d', '#ffc107', '#0dcaf0']}] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } }, onClick: (e, elements, chart) => { if(elements.length > 0) { const idx = elements[0].index; const label = chart.data.labels[idx].toLowerCase(); applyFilter('status', label); } } } });
        const assignedCounts = {}; data.forEach(item => { const p = item["Assigned To"] || 'AtanmadÄ±'; assignedCounts[p] = (assignedCounts[p] || 0) + 1; });
        const ctxAssigned = document.getElementById('chartAssigned').getContext('2d'); charts.assigned = new Chart(ctxAssigned, { type: 'doughnut', data: { labels: Object.keys(assignedCounts), datasets: [{ data: Object.values(assignedCounts), backgroundColor: ['#0d6efd', '#6610f2', '#d63384', '#fd7e14', '#20c997', '#adb5bd']}] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } }, onClick: (e, elements, chart) => { if(elements.length > 0) { const idx = elements[0].index; const label = chart.data.labels[idx]; applyFilter('assigned', label); } } } });
        const timelineData = {}; data.forEach(item => { const cDate = item["Created Date"]; if (cDate) { if (!timelineData[cDate]) timelineData[cDate] = { opened: 0, closed: 0 }; timelineData[cDate].opened++; } let clDate = item["Closed_Date"] || item["Completion Date"]; if (clDate && clDate.includes('-')) { const p = clDate.split('-'); clDate = `${p[2]}.${p[1]}.${p[0]}`; } if (clDate) { if (!timelineData[clDate]) timelineData[clDate] = { opened: 0, closed: 0 }; timelineData[clDate].closed++; } });
        const sortedDates = Object.keys(timelineData).sort((a, b) => { const da = a.split('.').reverse().join('-'); const db = b.split('.').reverse().join('-'); return new Date(da) - new Date(db); });
        const ctxTimeline = document.getElementById('chartTimeline').getContext('2d'); charts.timeline = new Chart(ctxTimeline, { type: 'line', data: { labels: sortedDates, datasets: [ { label: 'AÃ§Ä±lan', data: sortedDates.map(d => timelineData[d].opened), borderColor: '#0d6efd', backgroundColor: 'rgba(13, 110, 253, 0.1)', fill: true }, { label: 'Kapanan', data: sortedDates.map(d => timelineData[d].closed), borderColor: '#198754', backgroundColor: 'rgba(25, 135, 84, 0.1)', fill: true } ] }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false } } });
    }

    function applyFilter(type, value) {
        let filtered = []; let text = "";
        if (type === 'status') { filtered = allTickets.filter(t => (t["Status"] || '').toLowerCase() === value); text = `Durumu "<strong>${value.toUpperCase()}</strong>" olan kayÄ±tlar`; } 
        else if (type === 'assigned') { filtered = allTickets.filter(t => (t["Assigned To"] || 'AtanmadÄ±') === value); text = `Atanan kiÅŸi "<strong>${value}</strong>" olan kayÄ±tlar`; }
        renderTable(filtered);
        const alertBox = document.getElementById('filterAlert'); document.getElementById('filterText').innerHTML = text; alertBox.classList.remove('d-none');
    }
    function clearFilter(refreshTable = true) { document.getElementById('filterAlert').classList.add('d-none'); if(refreshTable) renderTable(allTickets); }

    document.getElementById('formNew').addEventListener('submit', async e => {
        e.preventDefault();
        const btn = document.getElementById('btnNew'); btn.disabled = true; document.getElementById('msgIdCalc').classList.remove('d-none');
        try {
            const newId = await getNextId();
            const today = new Date().toLocaleDateString('tr-TR');
            const body = { "Ticket ID": newId, "Title": document.getElementById('nSub').value, "Description": document.getElementById('nDesc').value, "Assigned To": document.getElementById('nAssigned').value || 'AtanmadÄ±', "Priority": document.getElementById('nPrio').value, "Status": "open", "Created Date": today };
            await fetch(URLS[mode].CREATE, { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(body) });
            bootstrap.Modal.getInstance(document.getElementById('modalNew')).hide(); document.getElementById('formNew').reset(); fetchTickets();
        } catch(err) { alert("Hata: " + err.message); }
        finally { btn.disabled = false; document.getElementById('msgIdCalc').classList.add('d-none'); }
    });

    document.getElementById('formUpd').addEventListener('submit', async e => {
        e.preventDefault();
        const btn = document.getElementById('btnUpd'); btn.disabled = true;
        const rawDate = document.getElementById('uDate').value;
        let formattedDate = ""; if(rawDate) { const parts = rawDate.split('-'); formattedDate = `${parts[2]}.${parts[1]}.${parts[0]}`; }
        const body = { "Ticket ID": document.getElementById('uId').value, "Status": document.getElementById('uStatus').value, "Action Taken": document.getElementById('uAction').value, "Completion Date": formattedDate };
        try {
            await fetch(URLS[mode].UPDATE, { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(body) });
            bootstrap.Modal.getInstance(document.getElementById('modalUpd')).hide(); fetchTickets();
        } catch(err) { alert("Hata: " + err.message); }
        finally { btn.disabled = false; }
    });

    async function fetchHistory(id) {
        const loader = document.getElementById('historyLoader'); const container = document.getElementById('historyContent'); const errorDiv = document.getElementById('historyError');
        container.classList.add('d-none'); errorDiv.classList.add('d-none'); loader.classList.remove('d-none'); container.innerHTML = '';
        try {
            const res = await fetch(`${URLS[mode].HISTORY}?id=${id}`, { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({}) });
            if(!res.ok) throw new Error(`${res.status}`);
            const text = await res.text();
            let json = []; try { json = JSON.parse(text); } catch { json = []; }
            let logs = parseData(json);
            if(logs.length === 0) { container.innerHTML = '<div class="text-muted text-center py-3">GeÃ§miÅŸ yok.</div>'; } else {
                logs.reverse();
                logs.forEach(log => {
                    const updateDate = log["Update_Date"] || 'Tarih Yok';
                    let detailsHtml = '';
                    if(log["Status"]) { const s = log["Status"]; const badgeColor = s === 'closed' ? 'bg-secondary' : 'bg-success'; detailsHtml += `<div class="history-detail-row"><span class="history-label"><i class="bi bi-info-circle"></i> Durum:</span> <span class="badge ${badgeColor}">${s.toUpperCase()}</span></div>`; }
                    if(log["WhatAppend"]) detailsHtml += `<div class="history-detail-row"><span class="history-label"><i class="bi bi-tools"></i> Ä°ÅŸlem:</span> <span class="history-val text-break">${log["WhatAppend"]}</span></div>`;
                    if(log["Closed_Date"]) detailsHtml += `<div class="history-detail-row"><span class="history-label"><i class="bi bi-calendar-check"></i> KapanÄ±ÅŸ:</span> <span class="history-val fw-bold">${log["Closed_Date"]}</span></div>`;
                    if(log["Assigned To"]) detailsHtml += `<div class="history-detail-row"><span class="history-label"><i class="bi bi-person"></i> Atanan:</span> <span class="history-val">${log["Assigned To"]}</span></div>`;
                    const statusClass = (log["Status"] === 'closed') ? 'status-closed' : 'status-open';
                    container.innerHTML += `<div class="history-card ${statusClass}"><span class="history-date"><i class="bi bi-clock"></i> ${updateDate}</span>${detailsHtml}</div>`;
                });
            }
        } catch(e) { console.error(e); errorDiv.innerText = `Veri alÄ±namadÄ±: ${e.message}`; errorDiv.classList.remove('d-none'); } finally { loader.classList.add('d-none'); container.classList.remove('d-none'); }
    }

    // --- JIRA OLUÅžTURMA (DEBUG MODU) ---
    async function createJiraTask() {
        const id = document.getElementById('uId').value;
        const btn = document.getElementById('btnJira');
        
        const t = allTickets.find(x => (x["Ticket ID"] == id) || (x["id"] == id));
        if(!t) { alert("KayÄ±t verisine ulaÅŸÄ±lamadÄ±."); return; }

        // PAYLOAD OLUÅžTURMA (Senin FormatÄ±n)
        const payload = {
            "title": t["Title"] || "Konu Yok",
            "problem": t["Description"] || "AÃ§Ä±klama girilmemiÅŸ",
            "id": id.toString()
        };

        // CURL KOMUTUNU OLUÅžTUR
        const url = URLS[mode].JIRA;
        const authHeader = 'Basic ' + btoa(`${AUTH.USER}:${AUTH.PASS}`);
        const payloadStr = JSON.stringify(payload, null, 4);

        const curlCommand = `curl --location '${url}' \\
--header 'Content-Type: application/json' \\
--header 'Authorization: ${authHeader}' \\
--data '${payloadStr}'`;

        // KULLANICIYA GÃ–STER (Prompt ile kopyalanabilir)
        prompt("ðŸ‘‡ OLUÅžTURULAN CURL KOMUTU (KopyalayÄ±p terminalde test et):", curlCommand);

        // Ä°ÅžLEMÄ° GERÃ‡EKLEÅžTÄ°R (Fetch)
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> GÃ¶nderiliyor...';

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error(`Jira servisi hata dÃ¶ndÃ¼: ${res.status}`);

            alert("âœ… Jira kaydÄ± baÅŸarÄ±yla oluÅŸturuldu! Liste yenileniyor...");
            bootstrap.Modal.getInstance(document.getElementById('modalUpd')).hide();
            fetchTickets();

        } catch (error) {
            console.error(error);
            alert("âŒ Jira HatasÄ±: " + error.message + "\n(CURL komutunu kullanarak hatayÄ± n8n tarafÄ±nda kontrol et)");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    function reloadHistory() { const id = document.getElementById('uId').value; if(id) fetchHistory(id); }

    window.openUpd = function(id) {
        const t = allTickets.find(x => (x["Ticket ID"] == id) || (x["id"] == id));
        if(!t) return;
        document.getElementById('uId').value = t["Ticket ID"] || id;
        document.getElementById('uTitle').value = t["Title"] || '';
        document.getElementById('uStatus').value = (t["Status"]||'open').toLowerCase();
        document.getElementById('uAction').value = ""; 
        const dbDate = t["Closed_Date"] || t["Completion Date"] || '';
        document.getElementById('uDate').value = dbDate; 
        if(dbDate.includes('.')) { const parts = dbDate.split('.'); if(parts.length===3) document.getElementById('uDate').value = `${parts[2]}-${parts[1]}-${parts[0]}`; }

        const btnJira = document.getElementById('btnJira');
        const jiraKey = t["Jira_Key"] || t["jira_key"];
        
        if (jiraKey) {
            btnJira.disabled = true;
            btnJira.innerHTML = `<i class="bi bi-check-circle"></i> Jira'da Mevcut (${jiraKey})`;
            btnJira.className = "btn btn-sm btn-success opacity-75";
        } else {
            btnJira.disabled = false;
            btnJira.innerHTML = `<i class="bi bi-kanban"></i> Jira'ya Aktar`;
            btnJira.className = "btn btn-sm btn-outline-primary";
        }

        new bootstrap.Modal(document.getElementById('modalUpd')).show();
        fetchHistory(t["Ticket ID"] || id);
    }

    setMode('LIVE');
</script>
</body>
</html>
